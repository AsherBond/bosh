#!/usr/bin/env bash

# If a command fails, in a pipeline or not, exit immediately
set -e -o pipefail

function prepend_datetime() {
  awk -W interactive '{ system("echo -n [$(date +%FT%T%z)]"); print " " $0 }'
}

# Before redirecting stdout and stderr, copy the file descriptor for original
# stdout where BOSH is expecting an integer, and only that.
exec 3>&1
exec \
    1> >(prepend_datetime >> /var/vcap/sys/log/postgres-9.4/drain.out.log) \
    2> >(prepend_datetime >> /var/vcap/sys/log/postgres-9.4/drain.err.log)

output_for_bosh() {
    exit_code=$?

    if [ $exit_code -eq 0 ]; then
        echo "postgres-9.4 deamon is properly shutdown with Fast Shutdown mode (SIGINT)"
    else
        echo "drain failed"
    fi

    echo $exit_code >&3
}

trap output_for_bosh EXIT


postgres_pid=$(/var/vcap/packages/bpm/bin/bpm pid postgres-9.4)
kill -s SIGINT "${postgres_pid}"
